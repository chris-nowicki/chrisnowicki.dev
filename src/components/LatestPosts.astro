---
import { NUMBER_OF_ENTRIES } from '@/lib/site'
import { getBlogPosts } from '@/utils/blog-helpers'
import { readingTime } from '@/utils/reading-time'
import { cn } from '@/utils/utils'
import CardViewCount from '@/components/React/CardViewCount'

interface Props {
  limit?: number
}

const { limit = NUMBER_OF_ENTRIES } = Astro.props

const posts = await getBlogPosts(limit)

const postItems = posts.map((post) => ({
  href: `/blog/${post.id}`,
  slug: post.id,
  name: post.data.title,
  description: post.data.description,
  readTime: readingTime(post.rendered?.html ?? ''),
}))
---

{
  postItems.length > 0 && (
    <section class="mt-12 sm:mt-20">
      <header class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between sm:mb-8">
        <div>
          <span class="font-pixel-line text-sm uppercase tracking-widest text-muted-foreground">Latest</span>
          <h2 class="text-lg font-bold uppercase tracking-wide sm:text-2xl">Read my Latest Posts</h2>
        </div>
        <a
          href="/blog"
          class="text-muted-foreground text-sm md:text-base hover:text-foreground hidden md:block"
          data-astro-prefetch>
          View all posts
        </a>
      </header>
      <div class="grid grid-cols-1 sm:gap-4 sm:grid-cols-2 lg:grid-cols-3">
        {
          postItems.map((item, index) => (
            <a
              href={item.href}
              aria-label={`Read more about ${item.name}`}
              class={cn(
                'group relative block h-full overflow-hidden transition-all duration-200 ease-in-out',
                'md:rounded-lg md:border md:ring-1 md:ring-inset md:ring-foreground/5',
                'animate-fade-in-up',
                'before:absolute before:left-0 before:top-0 before:h-full before:w-1 before:bg-foreground before:opacity-0 before:transition-opacity before:duration-200',
                'hover:before:opacity-100',
                'md:before:rounded-l-lg'
              )}
              style={`animation-delay: ${index * 100}ms`}
              data-astro-prefetch>
              <div class="flex h-full flex-col p-0 sm:p-4">
                <span class="mb-1 font-pixel-line text-sm text-muted-foreground sm:mb-2">
                  {String(index + 1).padStart(2, '0')}
                </span>
                <h3 class="mb-0 text-base font-bold wrap-break-words sm:mb-2 sm:min-h-[2.5em] sm:text-xl">
                  {item.name}
                </h3>

                {item.description && (
                  <p class="mb-4 flex-1 text-sm text-muted-foreground">{item.description}</p>
                )}

                <div class="mt-auto pt-2 font-pixel-line text-sm text-muted-foreground">
                  {item.readTime}
                  <CardViewCount client:only="react" slug={item.slug} />
                </div>
              </div>
            </a>
          ))
        }
      </div>
      <div class="mt-4 sm:hidden">
        <a
          href="/blog"
          class="text-muted-foreground text-base hover:text-foreground"
          data-astro-prefetch>
          View all posts â†’
        </a>
      </div>
    </section>
  )
}
