---
import Container from '@/components/Container.astro'
import PageLayout from '@/layouts/PageLayout.astro'
import { SPEAKING } from '@/lib/site'
import { getSortedYears, groupEntriesByYear } from '@/utils/collection-dates'
import generateOgImageUrl from '@/utils/og-image'
import { getCollection, type CollectionEntry } from 'astro:content'
import UnifiedLink from '@/components/UnifiedLink.astro'
import ArrowRight from '@/assets/icons/arrow-right.svg'
import HorizonWrapper from '@/components/HorizonWrapper.astro'

export const prerender = false
const category = Astro.url.searchParams.get('category')

const data = (await getCollection('speaking')).sort(
  (a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf()
)

// Get all unique categories from speaking data
const allCategories = Array.from(
  new Set(data.flatMap((item) => item.data.category || []))
)

// Filter data by category if specified
const filteredData =
  category ?
    data.filter((item) => item.data.category?.includes(category))
  : data

type Speaking = Record<string, CollectionEntry<'speaking'>[]>
const speaking: Speaking = groupEntriesByYear<'speaking'>(filteredData)

const years = getSortedYears(speaking)

const ogImageUrl = generateOgImageUrl({
  header: `/${SPEAKING.TITLE.toUpperCase()}`,
  description: SPEAKING.DESCRIPTION,
})
---

<PageLayout
  title={SPEAKING.TITLE}
  description={SPEAKING.DESCRIPTION}
  image={ogImageUrl}>
  <Container>
    <section class="relative pt-20 text-sm">
      <header
        class="mb-10 flex w-full items-center justify-center text-center text-4xl font-semibold md:mb-16">
        <div class="w-3/5">My speaking engagements and conference talks!</div>
      </header>

      <h2 class="mb-2 text-lg font-semibold">Categories</h2>
      <HorizonWrapper>

        <UnifiedLink
        href="/speaking"
        class={`font-normal hover:text-blue-600 ${!category ? 'text-blue-600' : ''}`}>
        ALL
      </UnifiedLink>
      {
        allCategories.map((cat) => (
          <UnifiedLink
          href={`/speaking?category=${encodeURIComponent(cat)}`}
          class={`font-normal hover:text-blue-600 ${category?.toLowerCase() === cat.toLowerCase() ? ' text-blue-600' : ''}`}>
              {cat}
            </UnifiedLink>
          ))
        }
        </HorizonWrapper>


      <div class="relative space-y-0">
        <div
          class="absolute top-0 bottom-0 left-0 hidden w-px bg-gradient-to-b from-transparent via-gray-300 to-transparent sm:block"
          style="left: calc(3rem + 0.75rem);">
        </div>
        {
          years.map((year, yearIndex) => (
            <div class="group text-md">
              {yearIndex > 0 && (
                <div class="relative mb-8">
                  <div class="absolute top-0 right-0 left-0 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent" />
                </div>
              )}
              <div
                class={`grid grid-cols-1 gap-4 sm:grid-cols-[auto_1fr] sm:gap-6 ${yearIndex > 0 ? 'pt-2' : ''}`}>
                <div class="text-md pt-1 font-mono whitespace-nowrap text-gray-600 group-hover:text-blue-600">
                  {year}
                </div>
                <div class="sm:pl-6">
                  <div class="space-y-4">
                    {speaking[year].map((talk) => (
                      <div class="group/talk border-b border-gray-100 pb-4 last:border-b-0">
                        <h3 class="text-lg font-bold">{talk.data.title}</h3>
                        <p class="mb-2 text-gray-700">
                          {talk.data.description}
                        </p>
                        {talk.data.videoUrl && (
                          <a
                            href={talk.data.videoUrl}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="flex items-center gap-2 text-sm text-blue-600 hover:underline">
                            Watch Video
                            <ArrowRight
                              fill="currentColor"
                              class="h-4 w-4 shrink-0 text-blue-600 transition-all duration-200 ease-in-out group-hover/talk:translate-x-1"
                            />
                          </a>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          ))
        }
      </div>
    </section>
  </Container>
</PageLayout>
