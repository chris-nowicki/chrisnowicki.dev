---
import Container from '@/components/Container.astro'
import PageLayout from '@/layouts/PageLayout.astro'
import BlogPostHeader from '@/components/BlogPostHeader.astro'
import TableOfContents from '@/components/React/TableOfContents'
import { formatDate } from '@/utils/utils'
import generateOgImageUrl from '@/utils/og-image'
import { readingTime } from '@/utils/reading-time'
import { getCollection, render } from 'astro:content'

export const prerender = true

export async function getStaticPaths() {
  const posts = await getCollection(
    'blog',
    ({ data }) => import.meta.env.DEV || !data.draft
  )
  return posts.map((post) => ({ params: { slug: post.id }, props: { post } }))
}

const { post } = Astro.props
const { Content, headings } = await render(post)
const tocHeadings = headings.filter((h) => h.depth === 2 || h.depth === 3)

const postDate = formatDate(post.data.date.toDateString())
const postReadTime = readingTime(post.rendered?.html ?? '')

const ogImageUrl = generateOgImageUrl({
  header: '/BLOG',
  description: post.data.title,
  readTime: postReadTime,
})

const postSlug = post.id
---

<PageLayout
  title={post.data.title}
  description={post.data.description}
  image={ogImageUrl}>
  <div class="fixed top-0 left-0 z-50 h-1 w-full bg-border">
    <div id="reading-progress" class="h-full w-0 bg-muted-foreground transition-[width] duration-100"></div>
  </div>
  <div class="overflow-x-clip">
    <Container>
      <article class="text-sm sm:text-base">
        <div class="page-animate" style="--delay: 0ms">
          <BlogPostHeader
            title={post.data.title}
            date={postDate}
            readTime={postReadTime}
            slug={postSlug}
            image={post.data.image}
            draft={post.data.draft}
          />
        </div>
        <div class="relative">
          <div class="page-animate prose mt-10" style="--delay: 150ms">
            <Content />
          </div>
          <span class="page-animate font-cursive mt-8 block text-4xl text-foreground" style="--delay: 200ms">- Chris</span>
          {tocHeadings.length >= 2 && (
            <TableOfContents headings={tocHeadings} client:load />
          )}
        </div>
      </article>
    </Container>
  </div>
</PageLayout>

<script>
  function initReadingProgress() {
    const progressBar = document.getElementById('reading-progress')
    if (!progressBar) return

    let ticking = false

    const updateProgress = () => {
      const scrollHeight = document.documentElement.scrollHeight - window.innerHeight
      const scrollY = window.scrollY
      const progress = scrollHeight > 0 ? (scrollY / scrollHeight) * 100 : 0
      progressBar.style.width = `${Math.min(100, Math.max(0, progress))}%`
      ticking = false
    }

    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(updateProgress)
        ticking = true
      }
    })

    updateProgress()
  }

  initReadingProgress()
  document.addEventListener('astro:after-swap', initReadingProgress)
</script>
