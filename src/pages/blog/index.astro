---
import Container from '@/components/Container.astro'
import PageLayout from '@/layouts/PageLayout.astro'
import { BLOG } from '@/lib/site'
import generateOgImageUrl from '@/utils/og-image'
import { getPostsByCategory, getAllPostCategories } from '@/utils/blog-helpers'
import { readingTime } from '@/utils/reading-time'
import { formatDate, formatViewCount } from '@/utils/utils'
import CategoryMenu from '@/components/CategoryMenu.astro'
import { supabaseServer } from '@/lib/supabase'

export const prerender = false
const category = Astro.url.searchParams.get('category')

const posts = await getPostsByCategory(category)
const categories = await getAllPostCategories()

const pathname = new URL(Astro.request.url).pathname.split('/')[1]

// Fetch view counts for all posts directly from Supabase
let viewCounts: Record<string, number> = {}
try {
  if (posts.length > 0 && supabaseServer) {
    const slugs = posts.map((post) => post.id)
    
    const { data, error } = await supabaseServer
      .from('blog_views')
      .select('slug, view_count')
      .in('slug', slugs)

    if (error) {
      console.error('Error fetching view counts:', error)
    } else if (data) {
      // Create a map of slug -> view_count, defaulting to 0 for missing slugs
      slugs.forEach((slug) => {
        viewCounts[slug] = 0
      })
      data.forEach((row) => {
        viewCounts[row.slug] = row.view_count
      })
    }
  }
} catch (error) {
  console.error('Failed to fetch view counts:', error)
  // Continue with empty viewCounts object
}

const ogImageUrl = generateOgImageUrl({
  header: `/${BLOG.TITLE.toUpperCase()}`,
  description: BLOG.DESCRIPTION,
})
---

<PageLayout
  title={BLOG.TITLE}
  description={BLOG.DESCRIPTION}
  image={ogImageUrl}>
  <Container>
    <section class="relative pt-12 text-sm sm:pt-20">
      <header
        class="mb-8 flex w-full items-center justify-center text-center md:mb-16">
        <div class="w-full sm:w-4/5 md:w-3/5">
          <h1 class="text-2xl font-semibold sm:text-3xl md:text-4xl">
            My ramblings on the web about all things tech, life, and
            productivity!
          </h1>
        </div>
      </header>

      <CategoryMenu categories={categories} currentCategory={category} pathname={pathname} />

      {
        posts.length > 0 ?
          <div>
            {posts.map((post) => (
              <a
                href={`/blog/${post.id}`}
                class="group block rounded-lg p-4 hover:cursor-pointer hover:bg-muted">
                <div class="text-md flex flex-col gap-2 sm:flex-row sm:items-center">
                  <span class="order-1 text-muted-foreground sm:order-3">
                    {formatDate(post.data.date.toDateString())}
                  </span>
                  <span
                    class="order-3 hidden flex-1 bg-muted-foreground/20 px-2 sm:order-2 sm:block"
                    style="height: 1px; align-self: center;"
                  />
                  <h2 class="order-2 text-lg font-semibold sm:order-1">
                    {post.data.title}
                  </h2>
                </div>
                <p class="text-muted-foreground">{post.data.description}</p>
                <div class="mt-1 font-mono text-sm">
                  <span class="text-sm tracking-tight text-muted-foreground">
                    {readingTime(post.rendered?.html ?? '')} ·
                  </span>
                  {post.data.category && <span>{post.data.category}</span>}
                  <span class="text-sm tracking-tight text-muted-foreground">
                    {' '}· {formatViewCount(viewCounts[post.id] ?? 0)} views
                  </span>
                </div>
              </a>
            ))}
          </div>
        : <p class="text-muted-foreground">No blog posts found.</p>
      }
    </section>
  </Container>
</PageLayout>
