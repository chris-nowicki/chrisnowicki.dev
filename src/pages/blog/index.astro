---
import Container from '@/components/Container.astro'
import PageLayout from '@/layouts/PageLayout.astro'
import { BLOG } from '@/lib/site'
import generateOgImageUrl from '@/utils/og-image'
import { getPostsByCategory, getAllPostCategories } from '@/utils/blog-helpers'
import { readingTime } from '@/utils/reading-time'
import { formatDate, formatViewCount } from '@/utils/utils'
import CategoryMenu from '@/components/CategoryMenu.astro'
import { convexHttpClient } from '@/lib/convex'
import { api } from '../../../convex/_generated/api'

export const prerender = false

const category = Astro.url.searchParams.get('category')

const posts = await getPostsByCategory(category)
const categories = await getAllPostCategories()

const pathname = new URL(Astro.request.url).pathname.split('/')[1]

// Fetch view counts for all posts from Convex
const slugs = posts.map((post) => post.id)
let viewCounts: Record<string, number> = {}

if (convexHttpClient) {
  try {
    viewCounts = await convexHttpClient.query(api.blogViews.getViewCounts, { slugs })
  } catch (error) {
    console.error('Failed to fetch view counts from Convex:', error)
  }
}

const ogImageUrl = generateOgImageUrl({
  header: `/${BLOG.TITLE.toUpperCase()}`,
  description: BLOG.DESCRIPTION,
})
---

<PageLayout
  title={BLOG.TITLE}
  description={BLOG.DESCRIPTION}
  image={ogImageUrl}>
  <Container>
    <section class="relative pt-12 text-sm sm:pt-20">
      <header
        class="page-animate mb-8 flex w-full items-center justify-center text-center md:mb-16"
        style="--delay: 0ms">
        <div class="w-full sm:w-4/5 md:w-3/5">
          <h1 class="text-2xl font-semibold sm:text-3xl md:text-4xl">
            My ramblings on the web about all things tech, life, and
            productivity!
          </h1>
        </div>
      </header>

      <div class="page-animate" style="--delay: 100ms">
        <CategoryMenu categories={categories} currentCategory={category} pathname={pathname} />
      </div>

      {
        posts.length > 0 ?
          <div class="page-animate" style="--delay: 200ms">
            {posts.map((post) => (
              <a
                href={`/blog/${post.id}`}
                class="group block rounded-lg p-4 hover:cursor-pointer hover:bg-muted">
                <div class="text-md flex flex-col gap-2 sm:flex-row sm:items-center">
                  <span class="order-1 text-muted-foreground sm:order-3">
                    {formatDate(post.data.date.toDateString())}
                  </span>
                  <span
                    class="order-3 hidden flex-1 bg-muted-foreground/20 px-2 sm:order-2 sm:block"
                    style="height: 1px; align-self: center;"
                  />
                  <h2 class="order-2 text-lg font-semibold sm:order-1">
                    {post.data.title}
                  </h2>
                </div>
                <p class="text-muted-foreground">{post.data.description}</p>
                <div class="mt-1 font-mono text-sm">
                  <span class="text-sm tracking-tight text-muted-foreground">
                    {readingTime(post.rendered?.html ?? '')}
                  </span>
                  {post.data.category && <span> · {post.data.category}</span>}
                  {(viewCounts[post.id] ?? 0) > 0 && (
                    <span class="text-sm tracking-tight text-muted-foreground">
                      {' '}· {formatViewCount(viewCounts[post.id])} views
                    </span>
                  )}
                </div>
              </a>
            ))}
          </div>
        : <p class="page-animate text-muted-foreground" style="--delay: 200ms">No blog posts found.</p>
      }
    </section>
  </Container>
</PageLayout>
